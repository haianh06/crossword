<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>√î ch·ªØ - Talkshow</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#4b2c82; --bg2:#2196f3; --accent:#ff5722; }
    *{box-sizing:border-box}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff; margin:0; padding:20px; min-height:100vh; text-align:center;
    }
    h1{margin:6px 0 12px;font-size:2.2rem}
    .input-section{
      display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0;
    }
    .input-section input{
      padding:8px 12px;border-radius:8px;border:none;width:220px;max-width:40vw;
    }
    .btn{
      background:var(--accent);color:#fff;border:none;
      padding:9px 14px;border-radius:8px;cursor:pointer;font-weight:600;
    }
    .btn:hover{transform:scale(1.05)}
    #timer{font-weight:700;margin:10px 0}
    .hidden{display:none}
    .crossword{
      background:rgba(255,255,255,0.08);
      border-radius:12px;
      padding:20px;
      margin: 0 auto;
      max-width: 850px;
    }
    .row{
      display:flex;align-items:center;justify-content:flex-start;
      margin:8px 0;
    }
    .number{
      width:32px;height:32px;
      display:flex;align-items:center;justify-content:center;
      background:crimson;color:#fff;font-weight:bold;border-radius:4px;
      margin-right:6px;
    }
    .cells-wrap{ display:flex;align-items:center; }
    .cell{width:36px;height:36px;margin:1px}
    .cell input{
      width:100%;height:100%;text-align:center;
      font-size:18px;font-weight:bold;text-transform:uppercase;
      border:none;border-radius:6px;
      background:rgba(255,255,255,0.2);color:#fff;
    }
    .cell input:disabled{background:rgba(255,255,255,0.05)}
    .cell input:focus{outline:none;background:rgba(255,255,255,0.35)}
    .keyword{background:crimson!important}
    .check-btn{
      margin-left:10px;padding:5px 10px;border:none;border-radius:6px;
      cursor:pointer;font-weight:bold;background:var(--accent);color:#fff;
    }
    .check-btn:disabled{background:gray;cursor:not-allowed}
    .result{margin-left:8px;font-weight:bold}
    .correct{color:#4caf50}.wrong{color:#f44336}
    .keyword-display{
      margin-top:18px;font-size:1.5rem;font-weight:bold;letter-spacing:10px;text-align:center;
    }
    .keyword-letter{display:inline-block;width:28px;color:transparent;transition:.3s}
    .keyword-letter.active{color:gold;transform:scale(1.2);text-shadow:0 0 10px gold}
    .game-info{
      display:flex;gap:20px;justify-content:center;align-items:flex-start;
      max-width:1100px;margin:20px auto;
    }
    .leaderboard,.questions{
      background:#fff;color:#000;border-radius:12px;padding:14px;flex:1;min-width:260px;
    }
    .leaderboard h3,.questions h3{margin:6px 0 12px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:6px;text-align:center}
    th{background:#f5f5f5}
  </style>
</head>
<body>
  <h1>√î ch·ªØ Talkshow - ALGORITHMS</h1>

  <!-- nh·∫≠p ng∆∞·ªùi ch∆°i -->
  <div class="input-section" id="playerForm">
    <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
    <input type="email" id="playerEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n">
    <button class="btn" onclick="savePlayer()">B·∫Øt ƒë·∫ßu ch∆°i</button>
  </div>
  <div id="timer"></div>

  <!-- game section -->
  <div id="gameSection" class="hidden">
    <div class="crossword" id="crossword"></div>
    <div class="keyword-display" id="keywordDisplay"></div>

    <div style="margin-top:14px;">
      <button class="btn" onclick="submitGame()">üì© N·ªôp b√†i</button>
    </div>

    <div class="game-info">
      <div class="leaderboard">
        <h3>üèÜ Leaderboard</h3>
        <table>
          <thead><tr><th>H·∫°ng</th><th>T√™n</th><th>ƒê√∫ng</th><th>Th·ªùi gian (s)</th></tr></thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <div class="questions">
        <h3>üìù C√¢u h·ªèi</h3>
        <ol id="questionList"></ol>
      </div>
    </div>
  </div>

  <!-- admin -->
  <div style="margin-top:14px">
    <input type="password" id="adminPassword" placeholder="Admin password">
    <button class="btn" onclick="checkAdmin()">ƒêƒÉng nh·∫≠p admin</button>
    <span id="adminControls" class="hidden">
      <button class="btn" style="margin-left:8px" onclick="exportExcel()">Xu·∫•t Excel</button>
    </span>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxU_Mjtf4cvFJbBe_3MxroLvggk_Br_wP7ZftZsqpO05wYTjCO2N2Vy9xEswJg2XS5M4Q/exec"; // Apps Script URL
    let questions = [];
    let players = [], currentPlayer=null, timerInterval, startTime;

    // load c√¢u h·ªèi t·ª´ Google Sheets
    async function loadQuestions(){
      let res = await fetch(API_URL+"?mode=questions");
      questions = await res.json();

      const crosswordDiv = document.getElementById("crossword");
      const qList = document.getElementById("questionList");
      crosswordDiv.innerHTML = "";
      qList.innerHTML = "";

      // keyword = ch·ªØ c√°i ƒë·∫ßu ti√™n c·ªßa m·ªói ƒë√°p √°n
      const keyword = questions.map(q=>q.answer[0]).join("").toUpperCase();
      const keywordDisplay = document.getElementById("keywordDisplay");
      keywordDisplay.innerHTML="";
      keyword.split("").forEach(ch=>{
        const span=document.createElement("span");
        span.innerText=ch;
        span.classList.add("keyword-letter");
        keywordDisplay.appendChild(span);
      });
      const keywordLetters=document.querySelectorAll(".keyword-letter");

      // render crossword
      questions.forEach((q,rowIndex)=>{
        const row=document.createElement("div");
        row.classList.add("row");

        const numDiv=document.createElement("div");
        numDiv.classList.add("number");
        numDiv.innerText=q.number;
        row.appendChild(numDiv);

        const cellsWrap=document.createElement("div");
        cellsWrap.classList.add("cells-wrap");

        let inputs=[];
        for(let i=0;i<q.answer.length;i++){
          const cell=document.createElement("div");
          cell.classList.add("cell");
          const input=document.createElement("input");
          input.maxLength=1; input.disabled=true;
          if(i===0) input.classList.add("keyword");
          cell.appendChild(input);
          cellsWrap.appendChild(cell);
          inputs.push(input);
        }

        const btn=document.createElement("button");
        btn.innerText="Check";
        btn.classList.add("check-btn");
        btn.disabled=true;

        const resultSpan=document.createElement("span");
        resultSpan.classList.add("result");

        btn.addEventListener("click",()=>{
          const userAnswer=inputs.map(i=>i.value.toUpperCase()).join("");
          if(userAnswer===q.answer.toUpperCase()){
            resultSpan.innerText="‚úî ƒê√∫ng"; resultSpan.className="result correct";
            keywordLetters[rowIndex].classList.add("active");
            saveAnswer(q.number,userAnswer,"ƒê√∫ng");
          } else {
            resultSpan.innerText="‚úò Sai"; resultSpan.className="result wrong";
            saveAnswer(q.number,userAnswer,"Sai");
          }
          updateLeaderboard();
        });

        cellsWrap.appendChild(btn);
        cellsWrap.appendChild(resultSpan);
        row.appendChild(cellsWrap);
        crosswordDiv.appendChild(row);

        // render danh s√°ch c√¢u h·ªèi
        const li=document.createElement("li");
        li.innerText=q.question;
        qList.appendChild(li);
      });
    }

    function savePlayer(){
      const name=document.getElementById("playerName").value.trim();
      const email=document.getElementById("playerEmail").value.trim();
      if(!name||!email){alert("Vui l√≤ng nh·∫≠p t√™n v√† email.");return;}
      const now=new Date().toLocaleString();
      currentPlayer={Name:name,Email:email,Time:now,Answers:[],Correct:0,Duration:0};
      players.push(currentPlayer);
      document.getElementById("playerForm").classList.add("hidden");
      document.getElementById("gameSection").classList.remove("hidden");

      // unlock
      document.querySelectorAll(".cell input").forEach(i=>i.disabled=false);
      document.querySelectorAll(".check-btn").forEach(b=>b.disabled=false);

      clearInterval(timerInterval);
      startTime=Date.now();
      timerInterval=setInterval(updateTimer,1000);
    }

    function updateTimer(){
      const elapsed=Math.floor((Date.now()-startTime)/1000);
      document.getElementById("timer").innerText="‚è± Th·ªùi gian: "+elapsed+" gi√¢y";
      if(currentPlayer) currentPlayer.Duration=elapsed;
    }

    function saveAnswer(q,ans,status){
      if(!currentPlayer)return;
      currentPlayer.Answers.push({C√¢u:q,Tr·∫£_l·ªùi:ans,K·∫øt_qu·∫£:status});
      if(status==="ƒê√∫ng") currentPlayer.Correct++;
    }

    function submitGame(){
      if(!currentPlayer) return;
      clearInterval(timerInterval);
      alert("‚è± B·∫°n ƒë√£ n·ªôp b√†i! K·∫øt qu·∫£ ƒë∆∞·ª£c l∆∞u.");
      document.querySelectorAll(".cell input").forEach(i=>i.disabled=true);
      document.querySelectorAll(".check-btn").forEach(b=>b.disabled=true);

      // g·ª≠i d·ªØ li·ªáu l√™n Google Sheets
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          mode:"submit",
          name: currentPlayer.Name,
          email: currentPlayer.Email,
          correct: currentPlayer.Correct,
          duration: currentPlayer.Duration,
          answers: currentPlayer.Answers
        })
      });
    }

    function updateLeaderboard(){
      fetch(API_URL)
        .then(r => r.json())
        .then(players => {
          const body=document.getElementById("leaderboardBody");
          body.innerHTML="";
          players
            .sort((a,b)=>b.correct-a.correct || a.duration-b.duration)
            .forEach((p,i)=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.correct}</td><td>${p.duration}</td>`;
              body.appendChild(tr);
            });
        });
    }

    setInterval(updateLeaderboard,5000); // auto refresh leaderboard

    function checkAdmin(){
      const pass=document.getElementById("adminPassword").value;
      if(pass==="fdsclub2024"){
        document.getElementById("adminControls").classList.remove("hidden");
        alert("ƒêƒÉng nh·∫≠p admin th√†nh c√¥ng");
      } else alert("Sai m·∫≠t kh·∫©u!");
    }

    function exportExcel(){
      fetch(API_URL)
        .then(r => r.json())
        .then(players => {
          const ws=XLSX.utils.json_to_sheet(players);
          const wb=XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb,ws,"Players");
          XLSX.writeFile(wb,"crossword_players.xlsx");
        });
    }

    // load game
    loadQuestions();
  </script>
</body>
</html>
